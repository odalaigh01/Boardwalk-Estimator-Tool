<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LTC Boardwalk Cost Estimator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Mapping and Geospatial Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Esri Leaflet for ArcGIS Services -->
    <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>
    <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @media print {
            @page {
                margin: 0.5in;
            }
            .no-print { display: none !important; }
            body { 
                background-color: white !important; 
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .print-full { width: 100% !important; border: none !important; box-shadow: none !important; }
            .leaflet-control-container { display: none !important; }
            #map { 
                height: 400px !important; 
                border: 2px solid #334155 !important; /* Darker border for print */
                break-inside: avoid;
                margin-bottom: 0.5rem !important;
            }
            .print-legend {
                display: flex !important;
                gap: 20px !important;
                margin-top: 10px !important;
                margin-bottom: 25px !important;
                color: black !important;
            }
            /* Darken text for print legibility */
            .text-slate-400, .text-slate-500, .text-emerald-100, .text-emerald-200 {
                color: #334155 !important;
            }
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        #map { height: 350px; width: 100%; border-radius: 0.75rem; }
        @media (min-width: 768px) {
            #map { height: 400px; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans print:bg-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        const UNITS = {
            deckingLen: 12,
            supportLen: 12,
            shimLen: 12,
            boxQty: 1543
        };

        const HD_LINKS = {
            decking: "https://www.homedepot.com/s/2x10%20pressure%20treated%20lumber?NCNI-5",
            support: "https://www.homedepot.com/s/4x6%2012ft%20pressure%20treated%20timber?NCNI-5",
            shim: "https://www.homedepot.com/s/2x6%20pressure%20treated%20lumber?NCNI-5",
            screws: "https://www.homedepot.com/s/3%20inch%20deck%20screws?NCNI-5"
        };

        const Icon = ({ name, size = 18, className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const PriceInput = ({ label, value, onChange, link }) => (
            <div className="space-y-1.5">
                <div className="flex items-center justify-between">
                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{label}</label>
                    <a 
                        href={link} 
                        target="_blank" 
                        rel="noopener noreferrer"
                        className="text-[10px] flex items-center gap-1 text-orange-600 font-bold hover:text-orange-700 transition-colors uppercase"
                    >
                        Live Price <i data-lucide="external-link" style={{ width: 10, height: 10 }}></i>
                    </a>
                </div>
                <div className="relative">
                    <span className="absolute left-3 top-2 text-slate-400 text-sm font-bold">$</span>
                    <input 
                        type="number" 
                        step="0.01" 
                        value={value} 
                        onChange={(e) => onChange(e.target.value)}
                        className="w-full pl-7 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-xl text-right font-mono font-bold outline-none focus:border-emerald-500 focus:ring-4 focus:ring-emerald-50/50 transition-all"
                    />
                </div>
            </div>
        );

        const MaterialRow = ({ name, desc, qty, cost }) => (
            <tr className="group transition-colors hover:bg-slate-50/50 print:hover:bg-transparent print:border-b print:border-slate-100">
                <td className="px-3 md:px-6 py-4 print:pl-0">
                    <div>
                        <div className="font-bold text-slate-700 print:text-black text-xs md:text-sm">{name}</div>
                        <div className="text-[9px] md:text-[10px] text-slate-400 print:text-slate-600 font-bold uppercase tracking-widest">{desc}</div>
                    </div>
                </td>
                <td className="px-3 md:px-6 py-4 text-center text-slate-600 font-medium font-mono text-xs md:text-sm print:text-black">{qty}</td>
                <td className="px-3 md:px-6 py-4 text-right font-bold text-slate-700 print:text-black print:pr-0 text-xs md:text-sm">
                    ${(cost || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                </td>
            </tr>
        );

        const BoardwalkMap = ({ onLengthCalculated }) => {
            const mapInstance = useRef(null);
            const geoJsonLayer = useRef(null);
            const [fileName, setFileName] = useState("");

            useEffect(() => {
                if (!mapInstance.current) {
                    mapInstance.current = L.map('map').setView([45.4, -84.9], 9);
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap'
                    }).addTo(mapInstance.current);

                    L.esri.featureLayer({
                        url: 'https://services.arcgis.com/M0RcaZONLNmkvwdY/arcgis/rest/services/LTC_Nature_Preserves_2025/FeatureServer/0',
                        style: {
                            color: '#059669', weight: 2, opacity: 0.8, fillColor: '#10b981', fillOpacity: 0.3
                        }
                    }).addTo(mapInstance.current).bindPopup(function (layer) {
                        return L.Util.template('<strong>Preserve:</strong> {Preserve_Name}', layer.feature.properties);
                    });

                    L.esri.featureLayer({
                        url: 'https://services.arcgis.com/M0RcaZONLNmkvwdY/arcgis/rest/services/WFR_2022/FeatureServer/0',
                        style: {
                            color: '#1e3a8a', weight: 1, opacity: 0.7, fillColor: '#3b82f6', fillOpacity: 0.2
                        }
                    }).addTo(mapInstance.current).bindPopup(function (layer) {
                        return L.Util.template('<strong>Working Forest Reserve:</strong> {Name}', layer.feature.properties);
                    });
                }
            }, []);

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setFileName(file.name);

                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const buffer = event.target.result;
                        const geojson = await shp(buffer);

                        if (geoJsonLayer.current) {
                            mapInstance.current.removeLayer(geoJsonLayer.current);
                        }

                        geoJsonLayer.current = L.geoJSON(geojson, {
                            style: { color: '#dc2626', weight: 5, opacity: 0.9 }
                        }).addTo(mapInstance.current);

                        mapInstance.current.invalidateSize();

                        const bounds = geoJsonLayer.current.getBounds();
                        if (bounds.isValid()) {
                            mapInstance.current.fitBounds(bounds, {
                                padding: [40, 40],
                                maxZoom: 17,
                                animate: true
                            });
                        }

                        const lengthKm = turf.length(geojson, { units: 'kilometers' });
                        const lengthFeet = Math.round(lengthKm * 3280.84);
                        onLengthCalculated(lengthFeet);
                    } catch (err) {
                        console.error("Error parsing shapefile:", err);
                        alert("Error parsing zipped shapefile. Ensure it contains .shp and .dbf files.");
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            return (
                <section className="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-slate-200 mb-6 print:p-0 print:border-none print:shadow-none print:mb-4">
                    <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-4 border-b pb-2 no-print gap-2">
                        <h2 className="text-lg font-semibold flex items-center gap-2 text-slate-700">
                            <Icon name="map" className="text-emerald-600" />
                            Trail Mapping
                        </h2>
                        <label className="cursor-pointer bg-emerald-50 text-emerald-700 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-emerald-100 transition-colors border border-emerald-100 flex items-center justify-center gap-1.5">
                            <Icon name="upload" size={14} />
                            UPLOAD TRACK
                            <input type="file" className="hidden" accept=".zip" onChange={handleFileUpload} />
                        </label>
                    </div>
                    
                    <div id="map" className="z-0 border border-slate-100 shadow-inner overflow-hidden"></div>
                    
                    <div className="flex flex-wrap gap-x-4 gap-y-2 mt-3 print-legend">
                        <div className="flex items-center gap-2">
                            <div className="w-3 h-3 bg-emerald-500 rounded-sm border border-emerald-600" style={{printColorAdjust: 'exact'}}></div>
                            <span className="text-[9px] md:text-[10px] font-bold text-slate-600 print:text-black uppercase">Nature Preserves</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <div className="w-3 h-3 bg-blue-500 rounded-sm border border-blue-600" style={{printColorAdjust: 'exact'}}></div>
                            <span className="text-[9px] md:text-[10px] font-bold text-slate-600 print:text-black uppercase">Working Forest</span>
                        </div>
                        <div className="flex items-center gap-2 ml-0 sm:ml-auto">
                            <div className="w-3 h-0.5 bg-red-600" style={{printColorAdjust: 'exact'}}></div>
                            <span className="text-[9px] md:text-[10px] font-bold text-slate-600 print:text-black uppercase">Uploaded Track</span>
                        </div>
                    </div>

                    {fileName && <p className="text-[10px] text-emerald-700 font-bold uppercase mt-2 print:mt-1 print:text-black">Active Track: {fileName}</p>}
                </section>
            );
        };

        const App = () => {
            const [trailLength, setTrailLength] = useState(100);
            const [costs, setCosts] = useState({
                decking: 26.08,
                support: 33.88,
                shim: 12.75,
                screws: 94.97,
            });

            const supportSpacing = 4;
            const avgShimsPerSupport = 2;
            const screwSafetyBuffer = 1.15;

            const calculations = useMemo(() => {
                const length = parseFloat(trailLength) || 0;
                const supportCount = length > 0 ? Math.ceil(length / supportSpacing) + 1 : 0;
                const shimCount = supportCount * avgShimsPerSupport;
                const rawScrews = supportCount * 9;
                const totalScrews = Math.ceil(rawScrews * screwSafetyBuffer); 

                const deckingItems = length > 0 ? Math.ceil(length / UNITS.deckingLen) * 3 : 0;
                const supportItems = supportCount > 0 ? Math.ceil(supportCount / (UNITS.supportLen / 3)) : 0;
                const shimItems = shimCount > 0 ? Math.ceil(shimCount / UNITS.shimLen) : 0; 
                const screwItems = totalScrews > 0 ? Math.ceil(totalScrews / UNITS.boxQty) : 0;

                const deckingTotalCost = deckingItems * costs.decking;
                const supportTotalCost = supportItems * costs.support;
                const shimTotalCost = shimItems * costs.shim;
                const fastenerTotalCost = screwItems * costs.screws;
                const totalCost = deckingTotalCost + supportTotalCost + shimTotalCost + fastenerTotalCost;

                const totalBF = ((2*10*(deckingItems*12)) + (4*6*(supportItems*12)) + (2*6*(shimItems*12))) / 12;

                return {
                    totalCF: totalBF / 12,
                    totalScrews,
                    deckingItems, supportItems, shimItems, screwItems,
                    costs: {
                        decking: deckingTotalCost,
                        support: supportTotalCost,
                        shim: shimTotalCost,
                        fastener: fastenerTotalCost,
                        total: totalCost
                    }
                };
            }, [trailLength, costs]);

            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, []);

            const handleCostChange = (key, val) => {
                const numericValue = parseFloat(val);
                setCosts(prev => ({ ...prev, [key]: isNaN(numericValue) ? 0 : numericValue }));
            };

            const handlePrint = () => window.print();

            return (
                <div className="p-4 md:p-8 max-w-6xl mx-auto print:p-4 print:max-w-none">
                    <header className="mb-6 md:mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4 border-b border-slate-200 pb-6 print:mb-4 print:border-slate-800">
                        <div>
                            <h1 className="text-2xl md:text-3xl font-bold text-emerald-900 flex items-center gap-2 leading-tight print:text-black">
                                <Icon name="trees" size={32} className="text-emerald-600 print:text-black flex-shrink-0" />
                                LTC Boardwalk Cost Estimator
                            </h1>
                        </div>
                        <div className="no-print w-full md:w-auto">
                            <button 
                                onClick={handlePrint}
                                className="w-full md:w-auto px-6 py-2.5 bg-emerald-600 border border-emerald-700 rounded-xl text-sm font-bold text-white hover:bg-emerald-700 transition-all flex items-center justify-center gap-2 shadow-sm"
                            >
                                <Icon name="printer" /> PRINT LIST
                            </button>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 md:gap-8">
                        {/* Column 1: Map & Inputs */}
                        <div className="lg:col-span-4 space-y-6 print:col-span-12 print:w-full">
                            <BoardwalkMap onLengthCalculated={setTrailLength} />
                            
                            <section className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 no-print">
                                <h2 className="text-lg font-semibold mb-4 flex items-center gap-2 border-b pb-2 text-slate-700">
                                    <Icon name="settings" className="text-slate-400" />
                                    Project Size
                                </h2>
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1 text-xs">Trail Length (Linear Feet)</label>
                                    <div className="relative">
                                        <input 
                                            type="number" 
                                            value={trailLength} 
                                            onChange={(e) => setTrailLength(e.target.value)}
                                            className="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none pl-10 font-bold"
                                        />
                                        <div className="absolute left-3 top-2.5 text-slate-400 font-mono text-xs">FT</div>
                                    </div>
                                </div>
                            </section>

                            <section className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 no-print">
                                <h2 className="text-lg font-semibold mb-4 flex items-center gap-2 border-b pb-2 text-slate-700">
                                    <Icon name="dollar-sign" className="text-slate-400" />
                                    Price per Item
                                </h2>
                                <div className="grid grid-cols-1 gap-5">
                                    <PriceInput label="2x10x12' Board ($)" value={costs.decking} link={HD_LINKS.decking} onChange={(v) => handleCostChange('decking', v)} />
                                    <PriceInput label="4x6x12' Timber ($)" value={costs.support} link={HD_LINKS.support} onChange={(v) => handleCostChange('support', v)} />
                                    <PriceInput label="2x6x12' Board ($)" value={costs.shim} link={HD_LINKS.shim} onChange={(v) => handleCostChange('shim', v)} />
                                    <PriceInput label="3&quot; Deck Screw Tub ($)" value={costs.screws} link={HD_LINKS.screws} onChange={(v) => handleCostChange('screws', v)} />
                                </div>
                            </section>
                        </div>

                        {/* Column 2: Results & Table */}
                        <div className="lg:col-span-8 space-y-6 print:col-span-12 print:w-full">
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 print:gap-2">
                                <div className="bg-emerald-600 text-white p-5 md:p-6 rounded-2xl shadow-lg border border-emerald-700 print:bg-white print:text-black print:border-slate-800 print:shadow-none">
                                    <p className="text-emerald-100 text-[10px] font-bold uppercase tracking-widest mb-1 print:text-slate-900">Total Project Cost</p>
                                    <h3 className="text-3xl md:text-4xl font-black print:text-3xl leading-none">${calculations.costs.total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h3>
                                    <p className="text-emerald-200 text-[10px] mt-2 font-medium print:text-slate-800">
                                       ${(calculations.costs.total / (parseFloat(trailLength) || 1)).toFixed(2)} per lin ft
                                    </p>
                                </div>
                                <div className="bg-white p-5 md:p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col justify-center print:shadow-none print:border-slate-800">
                                    <p className="text-slate-500 text-[10px] font-bold uppercase tracking-widest mb-1 text-center print:text-slate-900">Cubic Feet Volume</p>
                                    <h3 className="text-2xl md:text-3xl font-black text-slate-800 text-center flex items-center justify-center gap-2 leading-none print:text-black">
                                        <Icon name="box" size={20} className="text-blue-500 no-print" />
                                        {calculations.totalCF.toFixed(2)} <span className="text-xs font-bold text-slate-400 print:text-slate-600">CF</span>
                                    </h3>
                                    <p className="text-slate-400 text-[9px] mt-2 text-center uppercase font-bold tracking-tighter print:text-slate-600">Gross Lumber Volume</p>
                                </div>
                            </div>

                            <section className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden print:border-none print:shadow-none">
                                <div className="p-4 md:p-6 border-b border-slate-100 flex items-center justify-between bg-white print:px-0 print:border-slate-800">
                                    <h2 className="text-base md:text-lg font-bold flex items-center gap-2 text-slate-800 print:text-black">
                                        <Icon name="table" className="text-emerald-600 print:text-black flex-shrink-0" />
                                        Required Materials List ({parseFloat(trailLength) || 0} FT)
                                    </h2>
                                    <button 
                                        onClick={() => setTrailLength(100)}
                                        className="no-print p-1.5 bg-slate-50 border border-slate-200 rounded-lg text-slate-400 hover:text-emerald-600 transition-all"
                                        title="Reset length"
                                    >
                                        <Icon name="refresh-cw" size={16} />
                                    </button>
                                </div>
                                
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left border-collapse">
                                        <thead className="bg-slate-50 text-slate-400 font-bold uppercase tracking-tighter text-[9px] md:text-[10px] print:bg-slate-50 print:text-black print:border-b-2 print:border-black">
                                            <tr>
                                                <th className="px-3 md:px-6 py-4 border-b print:px-2">Component</th>
                                                <th className="px-3 md:px-6 py-4 border-b text-center print:px-2">Order Qty</th>
                                                <th className="px-3 md:px-6 py-4 border-b text-right print:px-2">Ext. Price</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-50 print:divide-slate-200">
                                            <MaterialRow name="2x10 Decking (GC)" desc="3 Rows (12' units)" qty={`${calculations.deckingItems} boards`} cost={calculations.costs.decking} />
                                            <MaterialRow name="4x6 Ground Supports" desc="4 pieces (3' each) per timber" qty={`${calculations.supportItems} timbers`} cost={calculations.costs.support} />
                                            <MaterialRow name="2x6 Shim Material" desc="12 pieces (1' each) per board" qty={`${calculations.shimItems} boards`} cost={calculations.costs.shim} />
                                            <MaterialRow name="3&quot; Deck Screws" desc={`Includes 15% extra`} qty={`${calculations.screwItems} tub`} cost={calculations.costs.fastener} />
                                        </tbody>
                                        <tfoot className="bg-slate-50 font-bold text-slate-800 print:bg-white">
                                            <tr>
                                                <td className="px-3 md:px-6 py-5 border-t text-[10px] font-bold uppercase tracking-widest text-slate-400 print:px-2 print:text-slate-800">Total Estimate</td>
                                                <td className="border-t"></td>
                                                <td className="px-3 md:px-6 py-5 text-right text-emerald-800 font-black text-lg md:text-xl border-t print:px-2 print:text-black print:border-t-2 print:border-black">
                                                    ${calculations.costs.total.toLocaleString(undefined, {minimumFractionDigits: 2})}
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <div className="hidden print:block mt-8 pt-4 border-t border-slate-200 text-[10px] text-slate-500 text-center uppercase font-bold tracking-widest">
                                    Report generated by LTC Boardwalk Cost Estimator Tool â€¢ Support Spacing: 4'
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
