<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LTC Boardwalk Cost Estimator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Mapping and Geospatial Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Esri Leaflet for ArcGIS Services -->
    <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>
    <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @media print {
            @page { margin: 0.5in; size: portrait; }
            .no-print { display: none !important; }
            body { background-color: white !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .print-full { width: 100% !important; border: none !important; box-shadow: none !important; }
            .leaflet-control-container { display: none !important; }
            
            #map { 
                height: 550px !important; 
                width: 100% !important;
                border: 2px solid #0f172a !important;
                break-inside: avoid;
                margin-bottom: 1rem !important;
                visibility: visible !important;
                display: block !important;
                background-color: #f1f5f9 !important;
            }
            .leaflet-tile-container img { visibility: visible !important; opacity: 1 !important; display: block !important; }
            .text-slate-400, .text-slate-500, .text-emerald-100, .text-emerald-200 { color: #0f172a !important; }
            h1, h2, th { color: black !important; }
        }
        
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        #map { 
            height: 400px; 
            width: 100%; 
            border-radius: 0.75rem; 
            border: 1px solid #e2e8f0; 
            background: #f1f5f9;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Report Mode Styles */
        .report-view #map { height: 550px !important; border: 2px solid #0f172a; border-radius: 0.25rem; }
        .report-view .sidebar { display: none; }
        .report-view .main-content { grid-column: span 12 / span 12; width: 100%; max-width: 800px; margin: 0 auto; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;

        const UNITS = { deckingLen: 12, supportLen: 12, shimLen: 12, boxQty: 1543 };

        const HD_LINKS = {
            decking: "https://www.homedepot.com/s/2x10%20pressure%20treated%20lumber?NCNI-5",
            support: "https://www.homedepot.com/s/4x6%2012ft%20pressure%20treated%20timber?NCNI-5",
            shim: "https://www.homedepot.com/s/2x6%2012ft%20pressure%20treated%20lumber?NCNI-5",
            screws: "https://www.homedepot.com/s/3%20inch%20deck%20screws?NCNI-5"
        };

        const Icon = ({ name, size = 18, className = "" }) => {
            useEffect(() => { lucide?.createIcons(); }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const PriceInput = ({ label, value, onChange, link }) => (
            <div className="space-y-1.5">
                <div className="flex items-center justify-between">
                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{label}</label>
                    <a href={link} target="_blank" rel="noopener noreferrer" className="text-[10px] flex items-center gap-1 text-orange-600 font-bold uppercase">
                        Live Price <Icon name="external-link" size={10} />
                    </a>
                </div>
                <div className="relative">
                    <span className="absolute left-3 top-2 text-slate-400 text-sm font-bold">$</span>
                    <input type="number" step="0.01" value={value} onChange={(e) => onChange(e.target.value)}
                        className="w-full pl-7 pr-3 py-2 bg-slate-50 border border-slate-200 rounded-xl text-right font-mono font-bold outline-none focus:border-emerald-500 transition-all" />
                </div>
            </div>
        );

        const MaterialRow = ({ name, desc, qty, cost }) => (
            <tr className="group transition-colors hover:bg-slate-50/50 print:border-b print:border-slate-100">
                <td className="px-3 md:px-6 py-4 print:pl-0">
                    <div className="font-bold text-slate-700 print:text-black text-xs md:text-sm">{name}</div>
                    <div className="text-[9px] md:text-[10px] text-slate-400 print:text-slate-700 font-bold uppercase">{desc}</div>
                </td>
                <td className="px-3 md:px-6 py-4 text-center text-slate-600 font-medium font-mono text-xs md:text-sm print:text-black">{qty}</td>
                <td className="px-3 md:px-6 py-4 text-right font-bold text-slate-700 print:text-black print:pr-0 text-xs md:text-sm">
                    ${(cost || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                </td>
            </tr>
        );

        const BoardwalkMap = ({ onLengthCalculated, mapRef, reportMode, setTilesLoading }) => {
            const mapInstance = useRef(null);
            const geoJsonLayer = useRef(null);
            const [fileName, setFileName] = useState("");

            useEffect(() => {
                if (!mapInstance.current) {
                    mapInstance.current = L.map('map', { preferCanvas: true }).setView([45.4, -84.9], 9);
                    
                    const airPhoto = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Tiles &copy; Esri',
                        crossOrigin: 'anonymous',
                        keepBuffer: 16
                    }).addTo(mapInstance.current);

                    // Track tile loading
                    airPhoto.on('loading', () => setTilesLoading(true));
                    airPhoto.on('load', () => setTilesLoading(false));

                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
                        opacity: 0.8, crossOrigin: 'anonymous'
                    }).addTo(mapInstance.current);

                    L.esri.featureLayer({
                        url: 'https://services.arcgis.com/M0RcaZONLNmkvwdY/arcgis/rest/services/LTC_Nature_Preserves_2025/FeatureServer/0',
                        style: { color: '#10b981', weight: 2.5, opacity: 1, fillColor: '#10b981', fillOpacity: 0.3 }
                    }).addTo(mapInstance.current).bindPopup(layer => layer.feature.properties.Preserve_Name);

                    L.esri.featureLayer({
                        url: 'https://services.arcgis.com/M0RcaZONLNmkvwdY/arcgis/rest/services/WFR_2022/FeatureServer/0',
                        style: { color: '#3b82f6', weight: 1.5, opacity: 0.9, fillColor: '#3b82f6', fillOpacity: 0.2 }
                    }).addTo(mapInstance.current).bindPopup(layer => layer.feature.properties.Name);

                    if (mapRef) mapRef.current = mapInstance.current;
                }
            }, []);

            // Explicitly sync the map when report mode toggles
            useEffect(() => {
                if (mapInstance.current) {
                    setTimeout(() => {
                        mapInstance.current.invalidateSize({ animate: false });
                    }, 400); // Wait for CSS transition
                }
            }, [reportMode]);

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setFileName(file.name);
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    try {
                        const geojson = await shp(ev.target.result);
                        if (geoJsonLayer.current) mapInstance.current.removeLayer(geoJsonLayer.current);
                        geoJsonLayer.current = L.geoJSON(geojson, { style: { color: '#ff0000', weight: 5, opacity: 1 } }).addTo(mapInstance.current);
                        mapInstance.current.fitBounds(geoJsonLayer.current.getBounds(), { padding: [40, 40] });
                        onLengthCalculated(Math.round(turf.length(geojson, { units: 'kilometers' }) * 3280.84));
                    } catch (err) { alert("Error parsing zipped shapefile."); }
                };
                reader.readAsArrayBuffer(file);
            };

            return (
                <section className="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-slate-200 mb-6 print:p-0 print:border-none print:shadow-none print:mb-4">
                    <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-4 border-b pb-2 no-print gap-2">
                        <h2 className="text-lg font-semibold flex items-center gap-2 text-slate-700">
                            <Icon name="map" className="text-emerald-600" /> Trail Mapping
                        </h2>
                        <label className="cursor-pointer bg-emerald-50 text-emerald-700 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-emerald-100 flex items-center justify-center gap-1.5 border border-emerald-100">
                            <Icon name="upload" size={14} /> UPLOAD TRACK
                            <input type="file" className="hidden" accept=".zip" onChange={handleFileUpload} />
                        </label>
                    </div>
                    <div id="map" className="z-0 overflow-hidden shadow-inner"></div>
                    <div className="flex flex-wrap gap-x-4 gap-y-2 mt-3 print:mt-1">
                        <div className="flex items-center gap-2"><div className="w-3 h-3 bg-emerald-500 rounded-sm"></div><span className="text-[9px] font-bold text-slate-600 uppercase">Preserves</span></div>
                        <div className="flex items-center gap-2"><div className="w-3 h-3 bg-blue-500 rounded-sm"></div><span className="text-[9px] font-bold text-slate-600 uppercase">Working Forest</span></div>
                        <div className="flex items-center gap-2 ml-auto"><div className="w-3 h-0.5 bg-red-600"></div><span className="text-[9px] font-bold text-slate-600 uppercase">Uploaded Track</span></div>
                    </div>
                    {fileName && <p className="text-[10px] text-emerald-700 font-bold uppercase mt-2 print:mt-1">Active: {fileName}</p>}
                </section>
            );
        };

        const App = () => {
            const [trailLength, setTrailLength] = useState(100);
            const [reportMode, setReportMode] = useState(false);
            const [tilesLoading, setTilesLoading] = useState(false);
            const mapRef = useRef(null);
            const [costs, setCosts] = useState({ decking: 26.08, support: 33.88, shim: 12.75, screws: 94.97 });

            const calculations = useMemo(() => {
                const len = parseFloat(trailLength) || 0;
                const supportCount = len > 0 ? Math.ceil(len / 4) + 1 : 0;
                const totalScrews = Math.ceil((supportCount * 9) * 1.15);
                const screwTubs = Math.ceil(totalScrews / UNITS.boxQty);
                
                const decking = len > 0 ? Math.ceil(len / 12) * 3 : 0;
                const support = supportCount > 0 ? Math.ceil(supportCount / 3) : 0;
                const shim = supportCount > 0 ? Math.ceil((supportCount * 2) / 12) : 0;
                
                const c = { 
                    decking: decking * costs.decking, 
                    support: support * costs.support, 
                    shim: shim * costs.shim, 
                    fastener: screwTubs * costs.screws 
                };
                c.total = c.decking + c.support + c.shim + c.fastener;
                
                const totalBF = ((2*10*(decking*12)) + (4*6*(support*12)) + (2*6*(shim*12))) / 12;
                
                return { totalCF: totalBF / 12, totalScrews, screwTubs, decking, support, shim, costs: c };
            }, [trailLength, costs]);

            const handleCostChange = (k, v) => { const n = parseFloat(v); setCosts(p => ({ ...p, [k]: isNaN(n) ? 0 : n })); };

            return (
                <div className={`p-4 md:p-8 max-w-6xl mx-auto transition-all ${reportMode ? 'report-view' : ''}`}>
                    <header className="mb-6 md:mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4 border-b border-slate-200 pb-6 print:mb-4 print:border-slate-800">
                        <div>
                            <h1 className="text-2xl md:text-3xl font-bold text-emerald-900 flex items-center gap-2 leading-tight print:text-black">
                                <Icon name="trees" size={32} className="text-emerald-600 print:text-black" /> LTC Boardwalk Cost Estimator
                            </h1>
                        </div>
                        <div className="no-print flex gap-2 w-full md:w-auto">
                            {reportMode ? (
                                <>
                                    <button onClick={() => setReportMode(false)} className="flex-1 md:w-auto px-4 py-2.5 bg-slate-200 text-slate-800 rounded-xl text-sm font-bold hover:bg-slate-300">
                                        BACK TO EDITOR
                                    </button>
                                    <button onClick={() => window.print()} disabled={tilesLoading} className={`flex-1 md:w-auto px-6 py-2.5 rounded-xl text-sm font-bold text-white transition-all flex items-center justify-center gap-2 ${tilesLoading ? 'bg-orange-400 cursor-not-allowed' : 'bg-emerald-600 hover:bg-emerald-700 shadow-lg'}`}>
                                        {tilesLoading ? <><Icon name="refresh-cw" className="animate-spin" /> LOADING TILES...</> : <><Icon name="printer" /> FINAL PRINT</>}
                                    </button>
                                </>
                            ) : (
                                <button onClick={() => setReportMode(true)} className="w-full md:w-auto px-6 py-2.5 bg-emerald-600 border border-emerald-700 rounded-xl text-sm font-bold text-white hover:bg-emerald-700 shadow-sm flex items-center justify-center gap-2">
                                    <Icon name="file-text" /> GENERATE REPORT
                                </button>
                            )}
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 md:gap-8">
                        <div className="lg:col-span-4 sidebar space-y-6">
                            <section className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                <h2 className="text-lg font-semibold mb-4 flex items-center gap-2 border-b pb-2 text-slate-700"><Icon name="settings" className="text-slate-400" /> Project Size</h2>
                                <label className="block text-sm font-medium text-slate-700 mb-1 text-xs uppercase">Trail Length (Feet)</label>
                                <div className="relative">
                                    <input type="number" value={trailLength} onChange={(e) => setTrailLength(e.target.value)} className="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none font-bold" />
                                    <div className="absolute left-3 top-2.5 text-slate-400 font-mono text-xs">FT</div>
                                </div>
                            </section>
                            <section className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                <h2 className="text-lg font-semibold mb-4 flex items-center gap-2 border-b pb-2 text-slate-700"><Icon name="dollar-sign" className="text-slate-400" /> Price per Item</h2>
                                <div className="grid grid-cols-1 gap-5">
                                    <PriceInput label="2x10x12' Board ($)" value={costs.decking} link={HD_LINKS.decking} onChange={(v) => handleCostChange('decking', v)} />
                                    <PriceInput label="4x6x12' Timber ($)" value={costs.support} link={HD_LINKS.support} onChange={(v) => handleCostChange('support', v)} />
                                    <PriceInput label="2x6x12' Board ($)" value={costs.shim} link={HD_LINKS.shim} onChange={(v) => handleCostChange('shim', v)} />
                                    <PriceInput label="3&quot; Deck Screw Tub ($)" value={costs.screws} link={HD_LINKS.screws} onChange={(v) => handleCostChange('screws', v)} />
                                </div>
                            </section>
                        </div>

                        <div className="main-content lg:col-span-8 space-y-6">
                            <BoardwalkMap onLengthCalculated={setTrailLength} mapRef={mapRef} reportMode={reportMode} setTilesLoading={setTilesLoading} />
                            
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 print:gap-2">
                                <div className="bg-emerald-600 text-white p-5 rounded-2xl shadow-lg border border-emerald-700 print:bg-white print:text-black print:border-slate-800 print:shadow-none">
                                    <p className="text-emerald-100 text-[10px] font-bold uppercase tracking-widest mb-1 print:text-slate-900">Total Project Cost</p>
                                    <h3 className="text-3xl font-black print:text-3xl leading-none">${calculations.costs.total.toLocaleString(undefined, {minimumFractionDigits: 2})}</h3>
                                    <p className="text-emerald-200 text-[10px] mt-2 font-medium print:text-slate-800">${(calculations.costs.total / (parseFloat(trailLength) || 1)).toFixed(2)} per lin ft</p>
                                </div>
                                <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 flex flex-col justify-center print:border-slate-800 print:shadow-none">
                                    <p className="text-slate-500 text-[10px] font-bold uppercase tracking-widest mb-1 text-center print:text-slate-900">Cubic Feet Volume</p>
                                    <h3 className="text-2xl md:text-3xl font-black text-slate-800 text-center leading-none print:text-black">{calculations.totalCF.toFixed(2)} <span className="text-xs font-bold text-slate-400">CF</span></h3>
                                    <p className="text-slate-400 text-[9px] mt-2 text-center uppercase font-bold print:text-slate-700">Gross Lumber Volume</p>
                                </div>
                            </div>

                            <section className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden print:border-none print:shadow-none">
                                <div className="p-4 md:p-6 border-b border-slate-100 flex items-center justify-between bg-white print:px-0 print:border-slate-800">
                                    <h2 className="text-base md:text-lg font-bold flex items-center gap-2 text-slate-800 print:text-black">
                                        <Icon name="table" className="text-emerald-600 print:text-black" /> Required Materials ({parseFloat(trailLength) || 0} FT)
                                    </h2>
                                </div>
                                <table className="w-full text-left border-collapse">
                                    <thead className="bg-slate-50 text-slate-400 font-bold uppercase tracking-tighter text-[9px] md:text-[10px] print:text-black print:border-b-2 print:border-black">
                                        <tr><th className="px-3 md:px-6 py-4 border-b">Component</th><th className="px-3 md:px-6 py-4 border-b text-center">Qty</th><th className="px-3 md:px-6 py-4 border-b text-right">Ext. Price</th></tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-50 print:divide-slate-200">
                                        <MaterialRow name="2x10 Decking (GC)" desc="3 Rows (12' units)" qty={`${calculations.decking} boards`} cost={calculations.costs.decking} />
                                        <MaterialRow name="4x6 Ground Supports" desc="4 pieces (3' each) per timber" qty={`${calculations.support} timbers`} cost={calculations.costs.support} />
                                        <MaterialRow name="2x6 Shim Material" desc="12 pieces (1' each) per board" qty={`${calculations.shim} boards`} cost={calculations.costs.shim} />
                                        <MaterialRow name="3&quot; Deck Screws" desc={`${calculations.totalScrews} screws (incl. 15% extra)`} qty={`${calculations.screwTubs} tub`} cost={calculations.costs.fastener} />
                                    </tbody>
                                    <tfoot className="bg-slate-50 font-bold text-slate-800 print:bg-white">
                                        <tr><td className="px-3 md:px-6 py-5 border-t text-[10px] font-bold uppercase text-slate-400">Total Estimate</td><td className="border-t"></td><td className="px-3 md:px-6 py-5 text-right text-emerald-800 font-black text-lg md:text-xl border-t print:text-black print:border-t-2 print:border-black">${calculations.costs.total.toLocaleString(undefined, {minimumFractionDigits: 2})}</td></tr>
                                    </tfoot>
                                </table>
                                <div className="hidden print:block mt-8 pt-4 border-t border-slate-200 text-[10px] text-slate-500 text-center uppercase font-bold">Report generated by LTC Boardwalk Cost Estimator Tool</div>
                            </section>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
